name: Predict and Serve using Subset of Reference Library
on:
    workflow_dispatch:
        inputs:
            model-id:
                required: true
                type: string
            n_samples:
                required: true
                type: string

permissions:
    contents: read

jobs:
    inference:
        if: github.repository != 'ersilia-os/eos-template'
        runs-on: ubuntu-latest

        steps:
            -   name: Print system details
                run: sudo lshw -short

            -   name: Check into ersilia-os/ersilia repo
                uses: actions/checkout@v3
                with:
                    repository: ersilia-os/ersilia

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@master
                with:
                    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
                    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    aws-region: eu-central-1
            
            -   name: Save pipeline start time
                run: |
                    echo "$(date +%s)" > meta.txt

            -   name: Get input library
                run: |
                    echo "Getting ${{ inputs.n_samples }} from reference library"
                    filename="reference_library.csv"
                    aws s3 cp s3://precalculations-bucket/"$filename" $filename
                    
                    # Get first n_samples+1 lines from reference library
                    head -n $(( ${{ inputs.n_samples }} + 1 )) $filename > subset_$filename.csv

            -   name: Add conda to system path
                run: echo $CONDA/bin >> $GITHUB_PATH

            -   name: Source conda
                run: source $CONDA/etc/profile.d/conda.sh

            -   name: Set Python to 3.10.10
                run: conda install -y python=3.10.10
            
            -   name: Install dependencies
                run: |
                    source activate
                    conda init
                    conda install git-lfs -c conda-forge
                    git-lfs install
                    conda install gh -c conda-forge
            
            -   name: Install ersilia
                run: |
                    source activate
                    python --version
                    echo "After conda init"
                    conda init
                    python -m pip install -e .[test]
            
            -   name: Run inference and upload outputs to S3
                run: |
                    source activate
                    echo "Sample model id selected: ${{ inputs.model-id }}"
                    ersilia fetch ${{ inputs.model-id }}
                    ersilia serve ${{ inputs.model-id }}
                    echo "${{ inputs.model-id }} succesfully fetched and served"
                    ersilia api -i subset_$filename.csv -o ../${{ github.SHA }}_sample.csv
                    aws s3 cp ../${{ github.SHA }}_sample.csv s3://precalculations-bucket/sample/${{ inputs.model-id }}/${{ github.SHA }}_sample.csv